<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Command Execution Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <style>
         .table-container {
            margin: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        #status-chart {
            width: 100%;
            height: 400px;
            margin-bottom: 20px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="d-flex justify-content-between align-items-center mt-3 mb-4">
            <h1>Command Execution Dashboard</h1>
            <div>
                <a href="/" class="btn btn-primary me-2">Home</a>
                <button id="logout-btn" class="btn btn-secondary">Logout</button>
            </div>
        </div>

        <div id="auth-alert" class="alert alert-warning hidden">
            Please log in to access this dashboard.
            <a href="/" class="btn btn-link">Go to Login</a>
        </div>

        <div id="dashboard-content">
            <div id="status-chart" class="table-container"></div>

            <div class="table-responsive table-container">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Command</th>
                            <th>Target Host</th>
                            <th>User</th>
                            <th>Start Time</th>
                            <th>End Time</th>
                            <th>Status</th>
                            <th>Exit Code</th>
                            <th>Output</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for execution in executions %}
                        <tr>
                            <td>{{ execution.id }}</td>
                            <td>{{ execution.command_name }}</td>
                            <td>{{ execution.target_host }}</td>
                            <td>{{ execution.user }}</td>
                            <td>{{ execution.start_time }}</td>
                            <td>{{ execution.end_time }}</td>
                            <td>{{ execution.status }}</td>
                            <td>{{ execution.exit_code }}</td>
                            <td><a href="/output/{{ execution.id }}">View Output</a></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Helper function to get JWT token from localStorage
        function getToken() {
            return localStorage.getItem('auth_token');
        }
        
        // Check if user is authenticated
        function isAuthenticated() {
            return getToken() !== null;
        }
        
        // Handle authentication
        document.addEventListener('DOMContentLoaded', function() {
            const authAlert = document.getElementById('auth-alert');
            const dashboardContent = document.getElementById('dashboard-content');
            
            if (!isAuthenticated()) {
                authAlert.classList.remove('hidden');
                dashboardContent.style.display = 'none';
            } else {
                authAlert.classList.add('hidden');
                dashboardContent.style.display = 'block';
                
                try {
                    const token = getToken();
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const isAdmin = payload.is_admin;
                    const username = payload.username;
                    
                    // If not admin, only show user's own executions
                    if (!isAdmin) {
                        document.querySelectorAll('tbody tr').forEach(row => {
                            const userCell = row.querySelector('td:nth-child(4)');
                            if (userCell && userCell.textContent.trim() !== username) {
                                row.style.display = 'none';
                            }
                        });
                    }
                } catch (e) {
                    console.error('Error parsing token', e);
                }
                
                // Logout button
                document.getElementById('logout-btn').addEventListener('click', function() {
                    localStorage.removeItem('auth_token');
                    window.location.href = '/';
                });
                
                // Render ECharts chart
                renderChart();
            }
        });
        
        // Function to render the ECharts chart
        function renderChart() {
            const executionsData = {{ executions|tojson }}; // Pass data from Flask to JS
            
            // Filter executions based on user role
            let filteredExecutions = executionsData;
            if (isAuthenticated()) {
                try {
                    const token = getToken();
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const isAdmin = payload.is_admin;
                    const username = payload.username;
                    
                    // If not admin, only show user's own executions
                    if (!isAdmin) {
                        filteredExecutions = executionsData.filter(exe => exe.user === username);
                    }
                } catch (e) {
                    console.error('Error parsing token', e);
                }
            }
            
            const statusCounts = {};
            filteredExecutions.forEach(execution => {
                statusCounts[execution.status] = (statusCounts[execution.status] || 0) + 1;
            });

            const chart = echarts.init(document.getElementById('status-chart'));
            const option = {
                title: {
                    text: 'Command Execution Status'
                },
                tooltip: {},
                legend: {
                    data: Object.keys(statusCounts)
                },
                xAxis: {
                    data: Object.keys(statusCounts)
                },
                yAxis: {},
                series: [{
                    name: 'Status',
                    type: 'bar',
                    data: Object.values(statusCounts)
                }]
            };
            chart.setOption(option);
        }
    </script>
</body>
</html>